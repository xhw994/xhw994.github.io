---
title: 和密码库泄露的斗争
date: 2019-04-14 19:06:00
categories:
- 随笔
tags:
- 算法
---

# 要防弱密码，也要防数据库。但主要还是防数据库。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;任何一个程序员，哪怕是软件工程的初学者，都应该清楚创建一个坚不可摧的密码的重要性。事实上，随着学习的深入，这四年内我的通用密码也已经改变了两次，并且对于那些使用一次后再也不需要访问的网站，我也开始使用[Keeper](https://keepersecurity.com/)或是Google的随机密码服务了。但强大的密码并不能让我高枕无忧，因为大部分情况下，问题会出在储存密码的那一边。我到现在都有些不敢相信为什么Facebook会[明文存储](https://krebsonsecurity.com/2019/03/facebook-stored-hundreds-of-millions-of-user-passwords-in-plain-text-for-years/)密码。但既然接受了这个事实，我便清楚地明白这世上没有几个可以让我放心的数据库。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我已经忘了第一次被盗用的情况了，能追溯的最早的是QQ号和VIP邮箱的盗用。某一段时间某个缺德份子在我的QQ空间里上传了大量的情色广告图片，但出人意料的是，他没有顺走我拿来养QQ宠物的Q币以及云盘（当时还不叫这个名字）里的敏感文件。真是一个有职业道德的人。后来我的VIP邮箱也被盗用了。缺德份子用我的账户信息在其他网站上进行了碰撞测试，并成功登陆了我的台服战网和一个我忘记我注册过的Steam账号。虽然没有造成太大的影响，但总归是心里面一根刺。雪上加霜的是，腾讯是不允许人工删除QQ号的。哪怕5年没有登陆我的QQ账号都没有被系统注销，更不用说VIP邮箱了。对它们我就只好不理不问。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那么我的密码是腾讯泄露的吗？QQ号我不知道，那是太久之前的事儿了，但VIP邮箱的泄露是有迹可循的。这里要感谢Youtube上 [Computerphile](https://www.youtube.com/user/Computerphile/) 频道提供的网站 [have i been pwned](https://haveibeenpwned.com/)（HIBP），它提供了快捷且安全的用户界面和API用来查询数据库泄露。

## 使用HIBP查验邮箱
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在HIBP主界面键入邮箱，它很快便告诉我这次泄露的罪魁祸首是网易。
<center>{% asset_img 1.jpg This is an image %}</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这件事我当时在微博上也有耳闻，但并没有想过太多，因为我本以为我没有用过网易服务的。我对着这个结果想了很久才意识到：十几年前，在我小学二年级的时候，我玩过《梦幻西游》，那是一款网易出品的游戏。当年的我还用零花钱买了将军令，也就是专门为《梦幻西游》开发的电子密保设备，这足可以看出我在小学就已经有一定的网络安全意识了。但又能如何呢？问题不是出在我身上，但泄露还是发生了。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据链接的[国内新闻](http://news.mydrivers.com/1/452/452173.htm)，这次发生在2015年的泄露总共包含五亿多条数据信息，包含用户名、MD5加密的密码、密码提示问题和答案、以及注册的IP和生日等。而HIBP官方给出的详细数据和新闻有相当的[出入](https://www.troyhunt.com/handling-chinese-data-breaches-in-have-i-been-pwned/)：约有两亿三千万账户被拖库，且泄露的信息包含明文密码。且不说MD5的密码已经可以被轻松[暴力破解](https://www.md5online.org/md5-decrypt.html)，就凭HIBP给出的数据更为详实这一点我就愿意相信我的明文密码已经被泄露了。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;测试其他邮箱的结果也令我失望：[Adobe](https://www.troyhunt.com/adobe-credentials-and-serious/)，[Nexus Mod](https://www.nexusmods.com/games/news/12670/)都泄露过我的用户信息。其中Nexus只泄露了加盐的密码，而Adobe因为加密方式太过幼稚完全可以看作是明文泄露。

## 使用HIBP查验密码

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;泄露邮箱已经是件大事了，但明文密码的泄露要更加严峻。很多人一生只用一个弱密码，如果这个密码被泄露了那他所有的信息都玩儿完了。我虽然有一定的安全意识，但让我给每个服务都设置一个独立且能记住的密码也是不现实的。我的方法不过是牢记三种独特的密码，再根据网站名添加特殊符号罢了。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HIBP提供了查验密码的用户界面和API。这里我使用用户界面来查询我的QQ密码：
<center>{% asset_img 2.jpg This is an image %}</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;结果残酷到让我想拿块豆腐撞死。其实我很想在这里写下我的密码的，但因为我的密保手机号处在冻结状态，我没办法更改我的QQ密码，因此只能作罢。如果用一句话来形容的话，那是一个看上去很酷也很安全，但仔细一想一定有无数人用过的密码。虽然我已经不用了但里面仍然有一些没清干净的信息，如果你们有人猜到那是什么密码的话还请手下留情。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查验其他密码的结果令我欣慰：我的三种密码和十几种变体没有任何一个被明文泄露过。这虽然不代表它们就一定是牢不可破的，但至少我现在不需要担忧过多。

# HIBP真的安全吗？

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;看到这里，有些人会说：你明文传送密码给HIBP难道就是安全的吗？你能保证这不是钓鱼吗？哪怕HIBP是可以信任的，哪怕它发送给后端的是加密过的密码，难道它就不能用加密好的密码去撞库吗？放心，HIBP早已经想好怎么解决这些问题了。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HIBP使用SHA-1来存储密码，它虽然不如其他加密手段安全，但却是明文或MD5这样的弱加密与bcrypt等强加密的良好折中。毕竟这些不是敏感的用户信息，而是网上随处可见的泄露数据。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;假设我想验证我的密码`P@ssw0rd`是否已被泄露，我首先要生成它的SHA-1的哈希值`21BD12DC183F740EE76F27B78EB39C8AD972A757`。现在如果我完全相信HIBP的话，我可以发送一个GET请求给HIBP来验证这段哈希值是否存在在它的数据库里。如果是的话我就可以改密码，如果不是的话我就可以关掉网页，高枕无忧了。但事实上，且不说我的包会不会被劫持，我真的愿意相信HIBP不会反向查询我的密码吗？答案是否定的。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HIBP真正的安全之处在于它使用了k-Anonymity查询法。关于它的详细以及整个后端如何运作可以参考他们的[博客文章](https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/)。这里我只概述一下它的运行原理：

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在上文中，我已经得到了我的密码的哈希值。但我并不需要将完整的哈希值发送给HIBP。相反，我只需要发送一定长度的子字符串给HIBP，配合本地验证我也可以得到我想要的结果。HIBP在这一步取k为5，也就是说，我只要发送哈希值的头5个字符`21BD1`就可以了。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;收到请求后，HIBP会查询所有头5位为`21BD1`的哈希值并返回。返回的值大概有500条左右，其中每一条都对应着不同的密码，但它们的哈希值的前5位都是相同的。注意冒号后面的数字是这个哈希值在所有数据库泄露中出现的频率：

> (21BD1) 0018A45C4D1DEF81644B54AB7F969B88D65:1 (对应 "lauragpe")
> (21BD1) 00D4F6E8FA6EECAD2A3AA415EEC418D38EC:2 (对应 "alexguo029")
> (21BD1) 011053FD0102E94D6AE2F8B83D76FAF94F6:1 (对应 "BDnd9102")
> (21BD1) 012A7CA357541F0AC487871FEEC1891C49C:2 (对应 "melobie")
> (21BD1) 0136E006E24E7D152139815FB0FC6A50B15:2 (对应 "quvekyny")
> ...

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我收到这500多个哈希后，只需要搜索自己的哈希值是否存在在这一串返回值里就可以判断我的密码是否被盗用了，并且因为HIBP采用了固定的`k`值，数据库索引非常有效，所以整个流程毫不费时。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;使用Postman模拟这一过，我得到了527个结果。每一条都代表着一个截取掉头5位的哈希值：

<center>{% asset_img 3.jpg %}</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;搜寻哈希值的后35位`2DC183F740EE76F27B78EB39C8AD972A757`，可知`P@ssw0rd`这个密码在所有已知的数据库泄露中共出现五万余次——不愧是非常差的密码。而从它的“前辈”`password`“仅仅”被泄露了三百多万次这一点可以看出使用Leet文字修饰密码这一方法也不能保证有效。

<center>{% asset_img 4.jpg %}</center>

# 简易终端

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;某些密码管理软件（如[1password](https://1password.com/)）默认使用HIBP来探测潜在的风险。但那些不使用密码管理软件，或者是用Chrome自带密码管理软件的人（比如我）也有查验密码的需求。所以我需要一个能快速查询大量密码的脚本：

{% codeblock lang:python 查询脚本，支持csv和txt文件 %}
import pandas as pd
import hashlib
import requests
import sys

# Send GET request to HIBP API
# to check if the given password has been pwnd
def check_one(p):
    api = 'https://api.pwnedpasswords.com/range/'
    # HIBP stores password with SHA-1 in uppercase
    h = hl.sha1(p.encode('utf-8')).hexdigest().upper()
    # k-Anonymity, k=5
    r = req.get(api + h[:5])
    for line in req.get(api + h[:5]).text.split('\r\n'):
        if h[5:] in line:
            # Return breakage count
            return int(line.split(':')[1])
    # Safe password
    return 0

fname = sys.argv[1]
df = pd.read_csv(fname)
# Format dataframe if input is a text file
if fname.endswith('.txt'):
    df.columns = ['password']
# Group by password to reduce the number of requests
dfg = df.groupby('password')

flag = False
# Iterate through all passwords
for name in dfg.groups.keys():
    t = check_one(name)
    if (t > 0): # Bad password
        flag = True
        print("'{}' has been compromised {} times!".format(name, t))
        # Print more information if given a Chrome export
        if (fname.endswith('.csv')):
            g = dfg.get_group(name)[['name','username']].rename(columns={'name':'website'})
            g.index = [''] * len(g)
            print("It has been used in the following websites:")
            print(g)
            print("")

# All passwords pass the test, amazing!
if not flag:
    print("Wow, such good passwords")
{% endcodeblock %}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我的初衷是只读取文本文档的，但后来我发现Chrome是可以[导出](https://support.google.com/chrome/answer/95606?co=GENIE.Platform%3DDesktop&hl=zh-Hans)存储的密码到csv文件的，于是我便引入了pandas来读取csv文件。下面是部分运行结果：

> 'admin' has been compromised 44432 times!
It has been used in the following websites:
              website username
  www.somewebsite.com    admin

> 'ak607425' has been compromised 5 times!
It has been used in the following websites:
              website              username
  wc.wolframalpha.com  fakeemail@gmail.com

> 'group13' has been compromised 134 times!
It has been used in the following websites:
      website username
  quizlet.com      NaN

> 'password' has been compromised 3645804 times!
It has been used in the following websites:
                                      website        username
          proj1.herokuapp.com   fake@uni.ca
  proj2.herokuapp.com     fake@uni.ca
      proj3.herokuapp.com  myadmin@uni.ca

> 'taiyuan' has been compromised 90 times!
It has been used in the following websites:
          website                                    username
  services.uni.ca  In which city I was born (all lower case)?

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;测试的结果还是相当让我满意的，被泄露的要么是别人的账号（我之后会通知他们的），要么就是我根本不在乎的账号或是假账号。这里的排版因为Markdown的缘故被打乱了，实际的输出会好看一点。值得注意的是最后一条，Chrome不仅记录密码还记录了密保问题的答案。我可以通过验证用户名和密码的格式来解决这个问题，但目前这段代码已经够用了。

# 小结和反思

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于密码库泄露和HIBP的探究就到此为止。毕竟我没有阻止密码库泄露的能力，碰上这种问题只能当作是天灾了。但这不代表我就应该对可能存在的风险视若无睹：使用密码管理器生成随机密码是最好的解决方法。如果网站不使用弱加密法或是明文存储密码，最好还能加点盐，那只要我的密码足够强，我的明文密码就不可能被泄露到网上去。缺德份子既然不会专门针对我的密码进行破解，那我只要尽力而为就足够了。